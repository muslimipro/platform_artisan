import{s as q,S as W,_ as G,T as H,a as K}from"./SimulationView-DSAXkudz.js";import{_ as Q}from"./IdeHeader.vue_vue_type_script_setup_true_lang-CMOCbhdp.js";import{s as X}from"./index-DGsR-a26.js";import{s as Y}from"./index-DnQmsymo.js";import{r as b,m as Z,y as k,ab as D,g as ee,e as w,aS as $,d as J,f as te,o as E,c as O,a as v,b as c,w as f,t as y,j as se,i as ne,F as U,q as j,s as oe}from"./index-DxkNwnS6.js";import{b as V,M as L,c as ae}from"./store-CP7asR24.js";import"./logo-B1m1Cn2A.js";import"./pibody-BwAjMvHk.js";import"./http-DDvZJtkB.js";function R(o,l,r){const s=w(typeof o=="function"?o():o);let t={...$(s)};return k(o,a=>{const d=$(a),i={};console.log(t,d);for(const n in d)console.log(n,d[n],t[n]),d[n]!==t[n]&&(i[n]=d[n]);console.log(Object.keys(i).length),Object.keys(i).length>0&&l(i),t={...d}},r)}const N=b(!1),I=o=>{const l=Date.now(),r=V(),s=D(r),t=[];t.push(k(s.isRunning,()=>{o({what:{kind:"run",state:s.isRunning.value},when:Date.now()-l})})),t.push(k(s.isStopping,()=>{o({what:{kind:"stop",state:s.isRunning.value},when:Date.now()-l})}));for(const e of r.slots)t.push(k(()=>e.with,()=>{o({what:{kind:"slot",slot:[e.id,e.with.type]},when:Date.now()-l})})),t.push(R(e.with.ref.pin2,a=>{if(console.log(e.with.ref.pin2.state,e.with.ref.pin2.mode,{...a}),e.with.type){const i={kind:e.with.ref.pin2.mode===L.IN?"in":"out",with:[e.id,e.with.type,{...a,id:2}]};o({what:i,when:Date.now()-l})}})),t.push(R(e.with.ref.pin3,a=>{if(e.with.type){const i={kind:e.with.ref.pin3.mode===L.IN?"in":"out",with:[e.id,e.with.type,{...a,id:3}]};o({what:i,when:Date.now()-l})}})),t.push(R(e.pin2,a=>{o({what:{kind:"pin",pin:{...a,id:e.pin2.id}},when:Date.now()-l})})),t.push(R(e.pin3,a=>{o({what:{kind:"pin",pin:{...a,id:e.pin3.id}},when:Date.now()-l})}));return t},ie=o=>{const l=[];V().reset(),N.value=!0;const s=I(e=>{l.push(e)});return()=>{for(const e of s)e.stop();return N.value=!1,l}},A=(o,l=3e3)=>{const r=b(!1),s=[],t=Z([]),e=V();e.reset();const a=I(i=>{t.push(i);const n=o[t.length-1];JSON.stringify(i.what)!==JSON.stringify(n.what)&&(console.log("Fail:",{at:t.length-1,happened:i,expected:n}),s.push({at:t.length-1,happened:i,expected:n}))});a.push(k(()=>t.length,()=>{const i=o[t.length];if(t.length>=o.length){d();return}const n=i.what;if(console.log("What:",n),n.kind==="in"){const[u,g,m]=n.with,T=e.getSlot(u);T.with.type;const S=m.id===2?T.with.ref.pin2:T.with.ref.pin3,{state:C=S.state,freq:F=S.freq}=m;S.state=C,S.freq=F}else n.kind==="run"?(console.log("Run:",n.state),n.state&&e.run()):n.kind==="stop"&&(console.log("Stop:",n.state),n.state&&e.stop())},{immediate:!0}));const d=()=>{for(const i of a)i.stop();r.value=!0};return{isEnded:r,Fails:s}},le=(o,l,r,s,t)=>{var g,m;const{user:e}=D(ee()),a={name:s,description:t,timestamp:new Date().toISOString(),version:"1.0",duration:o.length>0?o[o.length-1].when-o[0].when:0,testEnvironment:{userAgent:navigator.userAgent,platform:navigator.platform},moduleList:r,code:l,user:(g=e.value)==null?void 0:g.user_id,email:(m=e.value)==null?void 0:m.email,activity:o},d=JSON.stringify(a,null,2),i=new Blob([d],{type:"application/json"}),n=URL.createObjectURL(i),u=document.createElement("a");u.href=n,u.download=`${s.replace(/\s+/g,"_")}.json`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(n)},re=o=>new Promise((l,r)=>{const s=new FileReader;s.onload=t=>{var e;try{if(!((e=t.target)!=null&&e.result))throw new Error("Failed to read file");const a=JSON.parse(t.target.result);if(!Array.isArray(a.activity))throw new Error("Invalid activity format");l(a)}catch(a){r(a)}},s.onerror=t=>r(t),s.readAsText(o)}),ce={class:"material-icons"},de={class:"material-icons"},ue={class:"material-icons"},pe={class:"material-icons"},he={class:"material-icons"},fe={key:0},me=J({__name:"TesterControls",setup(o){const{fileContent:l}=D(ae()),r=V(),{isLoading:s}=D(r);let t=()=>[];const e=b([]),a=b(""),d=b("");let i="",n=[];const u=b(null),g=te(),m=b([]);function T(){n=[];for(const p of r.getSlots())n.push(p.with.type);i=l.value,t=ie()}function S(){stop();let p=t();e.value=p}function C(){le(e.value,i,n,a.value,d.value)}const F=async p=>{var _;const h=(_=p.target.files)==null?void 0:_[0];if(h)try{u.value=await re(h),e.value=u.value.activity,i=u.value.code,a.value=u.value.name,d.value=u.value.description,n=u.value.moduleList,console.log("Loaded Test Data:",u.value)}catch(x){console.error("Error loading JSON:",x)}},P=async()=>{l.value=i;for(let p=0;p<n.length;p++){const h=n[p];r.newModuleToSlotIndex(h,p)}j(()=>{const{isEnded:p,Fails:h}=A(e.value);m.value=h,k(p,()=>{h.length===0?g.add({severity:"success",summary:"Tests passed",life:3e3}):g.add({severity:"error",summary:"Tests failed",life:3e3}),r.stop()})})},B=async()=>{j(()=>{const{isEnded:p,Fails:h}=A(e.value);k(p,()=>{m.value=h,h.length===0?g.add({severity:"success",summary:"Tests passed",life:3e3}):g.add({severity:"error",summary:"Tests failed",life:3e3}),r.stop()})})};return(p,h)=>{const _=oe,x=Y,M=X;return E(),O(U,null,[v("div",null,[c(_,{type:"button",class:"w-9 h-9 mr-1",severity:"success",rounded:"",onClick:T,disabled:w(s)||w(N)},{default:f(()=>[v("span",ce,y(w(s)?"hourglass_top":"play_arrow"),1)]),_:1},8,["disabled"]),c(_,{type:"button",class:"w-9 h-9 mr-1",severity:"danger",rounded:"",onClick:S,disabled:w(s)||!w(N)},{default:f(()=>[v("span",de,y(w(s)?"hourglass_top":"stop"),1)]),_:1},8,["disabled"]),c(_,{type:"button",class:"w-9 h-9 mr-1",severity:"info",rounded:"",onClick:C,disabled:e.value.length<=0},{default:f(()=>[v("span",ue,y(w(s)?"hourglass_top":"save"),1)]),_:1},8,["disabled"])]),v("div",null,[c(x,{type:"text",modelValue:a.value,"onUpdate:modelValue":h[0]||(h[0]=z=>a.value=z),placeholder:"Name",disabled:e.value.length>0},null,8,["modelValue","disabled"])]),v("div",null,[c(M,{type:"text",modelValue:d.value,"onUpdate:modelValue":h[1]||(h[1]=z=>d.value=z),placeholder:"Description",disabled:e.value.length>0},null,8,["modelValue","disabled"])]),v("div",null,[c(_,{type:"button",class:"w-9 h-9 mr-1",severity:"info",rounded:"",onClick:P,disabled:e.value.length<=0},{default:f(()=>[v("span",pe,y(w(s)?"hourglass_top":"bug_report"),1)]),_:1},8,["disabled"]),c(_,{type:"button",class:"w-9 h-9 mr-1",severity:"warn",rounded:"",onClick:B,disabled:e.value.length<=0},{default:f(()=>[v("span",he,y(w(s)?"hourglass_top":"task"),1)]),_:1},8,["disabled"]),c(x,{type:"file",onChange:F,accept:"application/json",placeholder:"Name"})]),m.value.length>0?(E(),O("div",fe,y(m.value.length),1)):se("",!0),ne(" "+y(e.value.length),1)],64)}}}),we={class:"flex bg-surface-0",style:{height:"calc(100vh - 52px)"}},Re=J({__name:"TesterView",setup(o){return(l,r)=>{const s=K,t=q;return E(),O(U,null,[c(Q),v("div",we,[c(t,{class:"w-full rounded-none"},{default:f(()=>[c(s,{size:50,minSize:10,class:"max-w-[467px] w-full"},{default:f(()=>[c(W)]),_:1}),c(s,{size:50,minSize:10},{default:f(()=>[c(t,{layout:"vertical",class:"h-full w-full"},{default:f(()=>[c(s,{size:65,minSize:10},{default:f(()=>[c(G)]),_:1}),c(s,{size:35,minSize:10},{default:f(()=>[c(H)]),_:1})]),_:1})]),_:1}),c(s,{size:50,minSize:10},{default:f(()=>[c(me)]),_:1})]),_:1})])],64)}}});export{Re as default};
