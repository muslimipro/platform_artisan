import{S as _e,_ as be,T as we,s as ke,a as xe}from"./SimulationView-YkEID0T5.js";import{_ as Se}from"./IdeHeader.vue_vue_type_script_setup_true_lang-Bhyzzdxh.js";import{s as $e}from"./index-C19kJoCe.js";import{h as Ce,s as Re}from"./index-B_iG_Hws.js";import{d as q,h as w,aX as Le,o as x,c as S,a as d,F,n as H,aY as te,t as b,m as se,ag as Te,ad as De,q as Fe,f as Ne,ae as j,i as Ie,A as ne,l as Ve,b as a,w as y,u as f,ar as ze,x as le,s as Me}from"./index-B44sbgom.js";import{f as Ee,d as oe,i as Oe}from"./index-ChbGAM9M.js";import{_ as Pe}from"./SavedCloud.vue_vue_type_script_setup_true_lang-PfcDwCSL.js";import{a as B}from"./index-BNTzXF58.js";import{u as Ae}from"./editor-store-tBmAhcqm.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./logo-C5OIO6yL.js";import"./pibody-BwAjMvHk.js";import"./index-BTlblSkV.js";const Je={class:"w-full flex flex-col gap-4 overflow-auto"},Be={class:"flex gap-0.5"},He=["onClick"],je={class:"flex gap-0.5"},qe=["onClick"],Ue={key:0,class:"border rounded p-2 bg-gray-50 mt-4"},We={class:"font-semibold text-sm mb-2"},Ge={class:"text-xs overflow-auto"},Ke={key:1,class:"border rounded p-2 bg-gray-50 mt-4"},Xe={class:"font-semibold text-sm mb-2"},Ye={class:"text-xs overflow-auto"},Qe=q({__name:"ReplayTimeline",props:{feedback:{},inputs:{}},setup(g){const R=w(null),L=w(null),N=w(null),I=w(null);function o(i,r){R.value=r,L.value=i}const $=w([]),D=w([]);Le(()=>{const i=[];let r=0,v=0;for(let u=0;u<g.feedback.length;u++)g.feedback[u].expected?r<g.inputs.length&&v>=g.inputs[r].outputLength?(i.push({tag:"input",action:g.inputs[r].what}),r++,u--):(v++,i.push({tag:"output",action:g.feedback[u].expected,success:g.feedback[u].success})):i.push(null);const m=[];r=0,v=0;for(let u=0;u<g.feedback.length;u++)g.feedback[u].replayed?r<g.inputs.length&&v>=g.inputs[r].outputLength?(m.push({tag:"input",action:g.inputs[r].what}),r++,u--):(v++,m.push({tag:"output",success:g.feedback[u].success,action:g.feedback[u].replayed})):m.push(null);$.value=i,D.value=m});function p(i){let r="rgb(230, 230, 230)",v="rgb(150, 0, 0)";return i&&(i.tag==="input"?r="rgb(254, 101, 0)":i.success?r="rgb(1, 169, 0)":r="rgb(150, 30, 0)",v=r),{background:r,borderColor:v,borderWidth:"2px"}}return(i,r)=>(x(),S(F,null,[d("div",Je,[d("div",Be,[(x(!0),S(F,null,H($.value,(v,m)=>(x(),S("div",{class:"flex-1 h-4 min-w-4 cursor-pointer",style:te(p(v)),onClick:u=>o(v,m)},null,12,He))),256))]),d("div",je,[(x(!0),S(F,null,H(D.value,(v,m)=>(x(),S("div",{class:"flex-1 h-4 min-w-4 cursor-pointer",style:te(p(v)),onClick:u=>o(v,m)},null,12,qe))),256))])]),L.value!=null?(x(),S("div",Ue,[d("h2",We,"Feedback at index: "+b(R.value),1),d("pre",Ge,b(JSON.stringify(L.value,null,2)),1)])):se("",!0),N.value?(x(),S("div",Ke,[d("h2",Xe,"Input(s) at outputLength "+b(I.value),1),d("pre",Ye,b(JSON.stringify(N.value,null,2)),1)])):se("",!0)],64))}}),Ze={class:"p-4"},et={class:"flex w-full"},tt={class:"material-icons"},st={class:"material-icons"},nt={class:"material-icons"},lt={class:"material-icons"},ot={class:"flex justify-end"},at={class:"flex flex-col gap-4 mt-2"},it=["for"],ut={class:"material-icons"},ct={class:"material-icons"},rt=q({__name:"TesterControls",setup(g){const{locale:R}=Te(),L=De(),N=Ae(),{setStepSaving:I}=N;let o=w(null);const $=Fe(()=>o.value?o.value.content.tests:[]);Ne(async()=>{const t=ze();try{const{data:e}=await B.getStepTranslationByID(t.params.id.toString(),R.value);if(o.value=e,D.value=o.value.content.solution,o.value.content.highlights)for(const l of o.value.content.highlights)p.newModuleToSlot(l.module,l.slot)}catch(e){console.log(e)}});const{fileContent:D}=j(Ee()),p=oe(),{isLoading:i,isReplaying:r,isReplayTimeout:v}=j(p),m=w({moduleList:[],output:[],input:[]}),u=w({moduleList:[],output:[],input:[]}),P=Ie();let M=[];function ae(){M=[];for(const t of p.getSlots())M.push(t.with.type);m.value.moduleList=M,p.startRecording()}function ie(){m.value=p.stopRecording(),m.value.moduleList=M}function ue(t,e){const l={},s=Math.min(t.length,e.length);for(let n=0;n<s;n++)JSON.stringify(t[n])!==JSON.stringify(e[n])&&(l[n]={expected:{...t[n]},replayed:{...e[n]}});return l}const V=w([]);function ce(t,e){const l=[];for(let s=0;s<t.length&&s<e.length;s++)l.push({success:E(t[s],e[s]),expected:t[s],replayed:e[s]});for(let s=e.length;s<t.length;s++)l.push({success:!1,expected:t[s],replayed:null});for(let s=t.length;s<e.length;s++)l.push({success:!1,expected:null,replayed:e[s]});return l}function re(t,e){const l=de(t,e),s=[];let n=t.length,h=e.length;for(;n>0&&h>0;)E(t[n-1],e[h-1])?(s.unshift({success:!0,expected:t[n-1],replayed:e[h-1]}),n--,h--):l[n-1][h]>=l[n][h-1]?(s.unshift({success:!1,expected:t[n-1],replayed:null}),n--):(s.unshift({success:!1,expected:null,replayed:e[h-1]}),h--);for(;n>0;)s.unshift({success:!1,expected:t[n-1],replayed:null}),n--;for(;h>0;)s.unshift({success:!1,expected:null,replayed:e[h-1]}),h--;return s}function de(t,e){const l=Array(t.length+1).fill(0).map(()=>Array(e.length+1).fill(0));for(let s=1;s<=t.length;s++)for(let n=1;n<=e.length;n++)E(t[s-1],e[n-1])?l[s][n]=l[s-1][n-1]+1:l[s][n]=Math.max(l[s-1][n],l[s][n-1]);return l}function E(t,e){return JSON.stringify(t)===JSON.stringify(e)}function z(t){return JSON.stringify(t)}function U(t,e){const l=W(t),s=W(e),n=new Set;for(const c in l)l[c]===1&&s[c]===1&&n.add(c);const h=t.map((c,_)=>({action:c,index:_})).filter(({action:c})=>n.has(z(c))),k=e.map((c,_)=>({action:c,index:_})).filter(({action:c})=>n.has(z(c))),T=[],C=new Map;k.forEach(({action:c,index:_})=>{C.set(z(c),_)}),h.forEach(({action:c,index:_})=>{const ee=C.get(z(c));ee!==void 0&&T.push([_,ee])}),T.sort((c,_)=>c[0]-_[0]);const J=[];let Q=0,Z=0;for(const[c,_]of[...T,[t.length,e.length]])J.push(...fe(t.slice(Q,c),e.slice(Z,_))),c<t.length&&_<e.length&&J.push({success:!0,expected:t[c],replayed:e[_]}),Q=c+1,Z=_+1;return J}function fe(t,e){const l=[],s=Math.min(t.length,e.length);let n=0;for(;n<s;n++){const h=E(t[n],e[n]);l.push({success:h,expected:t[n],replayed:e[n]})}for(;n<t.length;n++)l.push({success:!1,expected:t[n],replayed:null});for(;n<e.length;n++)l.push({success:!1,expected:null,replayed:e[n]});return l}function W(t){const e={};return t.forEach(l=>{const s=z(l);e[s]=(e[s]||0)+1}),e}const O=w({name:"Histogram",algo:U});ne(O,()=>{const t=[];V.value.forEach(e=>{e.expected!==null&&t.push(e.expected)}),V.value=G(t,u.value.output)});const pe=w([{name:"LCS",algo:re},{name:"Linear",algo:ce},{name:"Histogram",algo:U}]);function G(t,e){return O.value.algo(t,e)}const K=w([]);function X(t){return K.value=t.input,new Promise(e=>{console.log(t),p.startReplaying(t.input,t.output.length);const l=ne(r,()=>{if(!r.value){u.value=p.getRecordedResults();let s="error";console.log(ue(t.output,u.value.output)),V.value=G(t.output,u.value.output),console.log(V.value),JSON.stringify(t.output)===JSON.stringify(u.value.output)&&(s="success"),P.add({severity:s,summary:"Replayed",life:3e3}),e()}v.value&&(P.add({severity:"warn",summary:"Replay timeout",life:3e3}),e()),l.stop()})})}const me=async()=>{for(const t of $.value)await Y(t)},Y=async t=>{var l;D.value=((l=o.value)==null?void 0:l.content.solution)??D.value;const e=await fetch(t.url).then(s=>s.json());if(e.moduleList)for(let s=0;s<e.moduleList.length;s++){const n=e.moduleList[s];p.newModuleToSlotIndex(n,s)}await le(),await X(e),await p.stopPromise()},he=async t=>{const e=await fetch(t.url).then(l=>l.json());await le(),await X(e),await p.stopPromise()};async function A(){if(o.value!=null){I(!0);try{await B.updateStepTranslationByID(o.value.step,R.value,o.value.name,o.value.content)}catch{P.add({severity:"error",summary:"Failed to save",detail:"I dunno what happened. Go cry to Bekzat; say that saving tests doesn't work",life:3e3})}finally{I(!1)}}}const ge=Oe(()=>{A()},1e3,{maxWait:5e3});async function ve(){if(o.value==null)return;const t={moduleList:m.value.moduleList,output:m.value.output,input:m.value.input},e=JSON.stringify(t),l=new Blob([e],{type:"application/json"}),s=new FormData;s.append("file",l,"default.test.json");const{data:n}=await B.uploadFile(s);o.value.content.tests?o.value.content.tests.push({name:"",url:n.presigned_url}):(o.value.content.tests=[],o.value.content.tests.push({name:"",url:n.presigned_url})),A()}function ye(t){L.require({message:"Are you sure you want to Delete?",header:"Confirmation",icon:"pi pi-exclamation-triangle",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Delete",severity:"danger"},accept:()=>{var e;(e=o.value)==null||e.content.tests.splice(t,1),A()}})}return(t,e)=>{const l=Me,s=Ce,n=Re,h=$e;return x(),S(F,null,[d("div",Ze,[Ve(" Recorded: "+b(m.value.output.length)+" Replayed: "+b(u.value.output.length)+" ",1),d("div",et,[a(l,{type:"button",class:"w-9 h-9 mr-1",severity:"success",rounded:"",onClick:ae,disabled:f(i)||f(p).isRecording},{default:y(()=>[d("span",tt,b(f(i)?"hourglass_top":"play_arrow"),1)]),_:1},8,["disabled"]),a(l,{type:"button",class:"w-9 h-9 mr-1",severity:"danger",rounded:"",onClick:ie,disabled:f(i)||!f(p).isRecording},{default:y(()=>[d("span",st,b(f(i)?"hourglass_top":"stop"),1)]),_:1},8,["disabled"]),a(l,{type:"button",class:"w-9 h-9",severity:"info",rounded:"",onClick:e[0]||(e[0]=k=>ve()),disabled:m.value.output.length<=0||f(o)==null},{default:y(()=>[d("span",nt,b(f(i)?"hourglass_top":"save"),1)]),_:1},8,["disabled"]),a(l,{type:"button",class:"w-9 h-9",severity:"info",rounded:"",onClick:e[1]||(e[1]=k=>me()),disabled:f(i)||f(p).isRecording||!$.value},{default:y(()=>[d("span",lt,b(f(i)?"hourglass_top":"bug_report"),1)]),_:1},8,["disabled"]),d("div",ot,[a(Pe)]),a(s,{modelValue:O.value,"onUpdate:modelValue":e[2]||(e[2]=k=>O.value=k),options:pe.value,optionLabel:"name",placeholder:"Select diff algorithm",class:"w-full md:w-40"},null,8,["modelValue","options"])]),d("div",at,[(x(!0),S(F,null,H($.value,(k,T)=>(x(),S("div",{class:"flex gap-2 w-full",key:k.url},[a(h,{variant:"on",class:"w-full"},{default:y(()=>[d("label",{for:`name${T}`},"Name",8,it),a(n,{id:`name${T}`,onInput:e[3]||(e[3]=C=>f(ge)()),modelValue:k.name,"onUpdate:modelValue":C=>k.name=C,"aria-describedby":"username-help",class:"w-full",size:"small"},null,8,["id","modelValue","onUpdate:modelValue"])]),_:2},1024),a(l,{type:"button",class:"w-9 h-9",severity:"info",rounded:"",onClick:C=>Y(k),disabled:f(i)||f(p).isRecording},{default:y(()=>[d("span",ut,b(f(i)?"hourglass_top":"bug_report"),1)]),_:2},1032,["onClick","disabled"]),a(l,{type:"button",class:"w-9 h-9",severity:"warn",rounded:"",onClick:C=>he(k),disabled:f(i)||f(p).isRecording},{default:y(()=>[d("span",ct,b(f(i)?"hourglass_top":"task"),1)]),_:2},1032,["onClick","disabled"]),a(l,{type:"button",class:"w-9 h-9",severity:"danger",rounded:"",onClick:C=>ye(T)},{default:y(()=>e[4]||(e[4]=[d("span",{class:"material-icons"},b("delete_forever"),-1)])),_:2},1032,["onClick"])]))),128))])]),a(Qe,{feedback:V.value,inputs:K.value},null,8,["feedback","inputs"])],64)}}}),dt={class:"flex bg-surface-0",style:{height:"calc(100vh - 52px)"}},$t=q({__name:"TesterView",setup(g){const R=oe(),{isRecording:L}=j(R);return(N,I)=>{const o=ke,$=xe;return x(),S(F,null,[a(Se),d("div",dt,[a($,{class:"w-full rounded-none"},{default:y(()=>[a(o,{size:50,minSize:10,class:"max-w-[467px] w-full"},{default:y(()=>[a(_e)]),_:1}),a(o,{size:50,minSize:10},{default:y(()=>[a($,{layout:"vertical",class:"h-full w-full"},{default:y(()=>[a(o,{size:65,minSize:10},{default:y(()=>[a(be,{disabled:f(L)},null,8,["disabled"])]),_:1}),a(o,{size:35,minSize:10},{default:y(()=>[a(we)]),_:1})]),_:1})]),_:1}),a(o,{size:50,minSize:10},{default:y(()=>[a(rt)]),_:1})]),_:1})])],64)}}});export{$t as default};
